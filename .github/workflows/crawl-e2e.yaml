name: Crawl E2E Test

on:
  push:
    branches:
      - main
      - "feat/**"
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build site2skill-go
        run: go build -o site2skillgo ./cmd/site2skillgo

      - name: Setup uv (for Python benchmark)
        uses: astral-sh/setup-uv@v4

      - name: Run site2skill-go crawl (default)
        id: go_default
        run: |
          echo "=== Running site2skill-go (default) ==="
          START_TIME=$(date +%s.%N)
          ./site2skillgo generate https://f4ah6o.github.io/site2skill-go/ test-go-skill
          END_TIME=$(date +%s.%N)
          ELAPSED=$(echo "$END_TIME - $START_TIME" | bc)
          echo "GO_DEFAULT_TIME=${ELAPSED}s" >> $GITHUB_OUTPUT
          echo ""
          echo "=== Go version results ==="
          find .claude/skills/test-go-skill -type f -name "*.md" | head -20
          find .claude/skills/test-go-skill -type f | wc -l
        continue-on-error: true

      - name: Run site2skill-go crawl (--locale-priority)
        id: go_locale
        run: |
          echo "=== Running site2skill-go with --locale-priority ja,en ==="
          START_TIME=$(date +%s.%N)
          ./site2skillgo generate --locale-priority "ja,en" https://f4ah6o.github.io/site2skill-go/ test-go-skill-locale
          END_TIME=$(date +%s.%N)
          ELAPSED=$(echo "$END_TIME - $START_TIME" | bc)
          echo "GO_LOCALE_TIME=${ELAPSED}s" >> $GITHUB_OUTPUT
          echo ""
          find .claude/skills/test-go-skill-locale -type f -name "*.md" | head -20
          find .claude/skills/test-go-skill-locale -type f | wc -l
        continue-on-error: true

      - name: Run site2skill-go crawl (--no-locale-priority)
        id: go_no_locale
        run: |
          echo "=== Running site2skill-go with --no-locale-priority ==="
          START_TIME=$(date +%s.%N)
          ./site2skillgo generate --no-locale-priority https://f4ah6o.github.io/site2skill-go/ test-go-skill-no-locale
          END_TIME=$(date +%s.%N)
          ELAPSED=$(echo "$END_TIME - $START_TIME" | bc)
          echo "GO_NO_LOCALE_TIME=${ELAPSED}s" >> $GITHUB_OUTPUT
          echo ""
          find .claude/skills/test-go-skill-no-locale -type f -name "*.md" | head -20
          find .claude/skills/test-go-skill-no-locale -type f | wc -l
        continue-on-error: true

      - name: Run Python site2skill crawl (benchmark)
        id: python_crawl
        run: |
          echo "=== Running Python site2skill ==="
          START_TIME=$(date +%s.%N)
          uvx --from git+https://github.com/laiso/site2skill site2skill \
            https://f4ah6o.github.io/site2skill-go/ test-python-skill
          END_TIME=$(date +%s.%N)
          ELAPSED=$(echo "$END_TIME - $START_TIME" | bc)
          echo "PYTHON_TIME=${ELAPSED}s" >> $GITHUB_OUTPUT
          echo ""
          echo "=== Python version results ==="
          find .claude/skills/test-python-skill -type f -name "*.md" 2>/dev/null | head -20 || echo "No .md files found"
          find .claude/skills/test-python-skill -type f 2>/dev/null | wc -l || echo "0"
        continue-on-error: true

      - name: Compare results
        run: |
          echo "========================================"
          echo "         BENCHMARK COMPARISON"
          echo "========================================"
          echo ""
          echo "--- Go version (site2skill-go) ---"
          GO_FILES=$(find .claude/skills/test-go-skill -type f 2>/dev/null | wc -l || echo "0")
          GO_LOCALE_FILES=$(find .claude/skills/test-go-skill-locale -type f 2>/dev/null | wc -l || echo "0")
          GO_NO_LOCALE_FILES=$(find .claude/skills/test-go-skill-no-locale -type f 2>/dev/null | wc -l || echo "0")
          echo "Total files (default): $GO_FILES"
          echo "Total files (--locale-priority): $GO_LOCALE_FILES"
          echo "Total files (--no-locale-priority): $GO_NO_LOCALE_FILES"
          echo ""
          echo "--- Python version (site2skill) ---"
          PY_FILES_RAW=$(find .claude/skills/test-python-skill -type f 2>/dev/null | wc -l || echo "0")
          # Subtract 2 for readme.md and search_docs.py (Python-specific files)
          PY_FILES=$((PY_FILES_RAW - 2))
          if [ "$PY_FILES" -lt 0 ]; then PY_FILES=0; fi
          echo "Total files: $PY_FILES (raw: $PY_FILES_RAW, -2 for readme.md/search_docs.py)"
          echo ""
          echo "========================================"

          # Get execution times from previous steps
          GO_DEFAULT_TIME="${{ steps.go_default.outputs.GO_DEFAULT_TIME }}"
          GO_LOCALE_TIME="${{ steps.go_locale.outputs.GO_LOCALE_TIME }}"
          GO_NO_LOCALE_TIME="${{ steps.go_no_locale.outputs.GO_NO_LOCALE_TIME }}"
          PYTHON_TIME="${{ steps.python_crawl.outputs.PYTHON_TIME }}"

          # Job Summary output
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Crawl E2E Benchmark Results

          | Version | Options | Files Generated | Execution Time |
          |---------|---------|----------------:|---------------:|
          | **Go** (site2skill-go) | (default) | $GO_FILES | $GO_DEFAULT_TIME |
          | **Go** (site2skill-go) | \`--locale-priority ja,en\` | $GO_LOCALE_FILES | $GO_LOCALE_TIME |
          | **Go** (site2skill-go) | \`--no-locale-priority\` | $GO_NO_LOCALE_FILES | $GO_NO_LOCALE_TIME |
          | **Python** (site2skill) | (none - no locale support) | $PY_FILES* | $PYTHON_TIME |

          *\* Python file count excludes \`readme.md\` and \`search_docs.py\` (Python-specific files) for fair comparison*

          ### ðŸ“ Generated Files (Go default)
          \`\`\`
          $(find .claude/skills/test-go-skill -type f -name "*.md" 2>/dev/null | head -10 || echo "No files found")
          \`\`\`
          EOF

      - name: Compare Go vs Python output diff
        run: |
          echo "=== Comparing site2skill-go vs Python site2skill output ==="

          GO_SKILL_DIR=".claude/skills/test-go-skill"
          PY_SKILL_DIR=".claude/skills/test-python-skill"

          HAS_DIFF=false
          DIFF_OUTPUT=""

          # Check if both directories exist
          if [ ! -d "$GO_SKILL_DIR" ] || [ ! -d "$PY_SKILL_DIR" ]; then
            echo "One or both skill directories do not exist. Skipping diff."
            exit 0
          fi

          # Compare documentation content (docs/ directory only)
          # Skip directory structure comparison as it includes skill name differences
          echo "--- Content Comparison (docs/*.md) ---"
          GO_DOCS_DIR="$GO_SKILL_DIR/docs"
          PY_DOCS_DIR="$PY_SKILL_DIR/docs"

          if [ -d "$GO_DOCS_DIR" ] && [ -d "$PY_DOCS_DIR" ]; then
            # Get common files
            GO_DOC_FILES=$(find "$GO_DOCS_DIR" -name "*.md" -exec basename {} \; | sort)
            PY_DOC_FILES=$(find "$PY_DOCS_DIR" -name "*.md" -exec basename {} \; | sort)
            COMMON_FILES=$(comm -12 <(echo "$GO_DOC_FILES") <(echo "$PY_DOC_FILES"))
            
            # Show file list differences (Go only / Python only)
            GO_ONLY=$(comm -23 <(echo "$GO_DOC_FILES") <(echo "$PY_DOC_FILES"))
            PY_ONLY=$(comm -13 <(echo "$GO_DOC_FILES") <(echo "$PY_DOC_FILES"))
            
            if [ -n "$GO_ONLY" ] || [ -n "$PY_ONLY" ]; then
              HAS_DIFF=true
              DIFF_OUTPUT+="### ðŸ“‚ docs/ File List Differences\n\n"
              if [ -n "$GO_ONLY" ]; then
                DIFF_OUTPUT+="**Go only:**\n\`\`\`\n$GO_ONLY\n\`\`\`\n\n"
              fi
              if [ -n "$PY_ONLY" ]; then
                DIFF_OUTPUT+="**Python only:**\n\`\`\`\n$PY_ONLY\n\`\`\`\n\n"
              fi
            fi
            
            if [ -n "$COMMON_FILES" ]; then
              CONTENT_DIFF=""
              for file in $COMMON_FILES; do
                # Compare content, filtering out skill name differences
                FILE_DIFF=$(diff \
                  <(sed 's/test-go-skill/SKILL_NAME/g' "$GO_DOCS_DIR/$file") \
                  <(sed 's/test-python-skill/SKILL_NAME/g' "$PY_DOCS_DIR/$file") \
                  2>/dev/null || true)
                if [ -n "$FILE_DIFF" ]; then
                  CONTENT_DIFF+="#### $file\n\`\`\`diff\n$FILE_DIFF\n\`\`\`\n\n"
                fi
              done
              
              if [ -n "$CONTENT_DIFF" ]; then
                HAS_DIFF=true
                DIFF_OUTPUT+="### ðŸ“„ Content Differences (docs/*.md)\n\n"
                DIFF_OUTPUT+="$CONTENT_DIFF"
              fi
            fi
          fi

          # Compare SKILL.md (filtering out skill name differences)
          echo "--- SKILL.md Comparison ---"
          GO_SKILL_MD="$GO_SKILL_DIR/SKILL.md"
          PY_SKILL_MD="$PY_SKILL_DIR/SKILL.md"

          if [ -f "$GO_SKILL_MD" ] && [ -f "$PY_SKILL_MD" ]; then
            # Replace skill names with placeholder before diff
            SKILL_MD_DIFF=$(diff \
              <(sed 's/test-go-skill/SKILL_NAME/g; s/TEST-GO-SKILL/SKILL_NAME/g' "$GO_SKILL_MD") \
              <(sed 's/test-python-skill/SKILL_NAME/g; s/TEST-PYTHON-SKILL/SKILL_NAME/g' "$PY_SKILL_MD") \
              || true)
            if [ -n "$SKILL_MD_DIFF" ]; then
              HAS_DIFF=true
              DIFF_OUTPUT+="### ðŸ“‹ SKILL.md Differences\n\n"
              DIFF_OUTPUT+="*(skill name differences filtered)*\n\n"
              DIFF_OUTPUT+="\`\`\`diff\n"
              DIFF_OUTPUT+="$SKILL_MD_DIFF\n"
              DIFF_OUTPUT+="\`\`\`\n\n"
            fi
          fi

          # Write to Job Summary only if there are differences
          if [ "$HAS_DIFF" = true ]; then
            echo ""
            echo "=== Differences Found ==="
            cat >> $GITHUB_STEP_SUMMARY << EOF

          ## ðŸ” Go vs Python Output Diff

          > Differences detected between site2skill-go and Python site2skill outputs.
          > *(Skill name differences are filtered out)*

          $(echo -e "$DIFF_OUTPUT")
          EOF
            echo "Diff has been added to Job Summary"
          else
            echo "No differences found between Go and Python outputs"
          fi

      - name: Upload Go skill artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-go-skill
          path: .claude/skills/test-go-skill/
        if: always()

      - name: Upload Python skill artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-python-skill
          path: .claude/skills/test-python-skill/
        if: always()

  robots-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build site2skill-go
        run: go build -o site2skillgo ./cmd/site2skillgo

      - name: Setup uv (for Python benchmark)
        uses: astral-sh/setup-uv@v4

      - name: Run Go site2skill-go robots.txt test
        run: |
          echo "=== Testing robots.txt compliance (Go) ==="
          ./site2skillgo generate https://f4ah6o.github.io/site2skill-go/ robots-test-go
        continue-on-error: true

      - name: Run Python site2skill robots.txt test
        run: |
          echo "=== Testing robots.txt compliance (Python) ==="
          uvx --from git+https://github.com/laiso/site2skill site2skill \
            https://f4ah6o.github.io/site2skill-go/ robots-test-python
        continue-on-error: true

      - name: Verify robots.txt compliance
        run: |
          echo "=== Checking for forbidden content ==="
          echo ""

          # Go version results
          GO_RESULT_NG="âœ… PASS"
          GO_RESULT_FORBIDDEN="âœ… PASS"

          echo "--- Go version (site2skill-go) ---"
          if grep -r "robots.txt BLOCKED" .claude/skills/robots-test-go/ 2>/dev/null; then
            echo "âŒ FAIL: /docs/ng/ content was crawled despite robots.txt disallow!"
            GO_RESULT_NG="âŒ FAIL"
          else
            echo "âœ… PASS: /docs/ng/ was correctly blocked"
          fi

          if grep -r "ç¦æ­¢ã‚³ãƒ³ãƒ†ãƒ³ãƒ„" .claude/skills/robots-test-go/ 2>/dev/null; then
            echo "âŒ FAIL: /docs/ja/forbidden/ content was crawled despite robots.txt disallow!"
            GO_RESULT_FORBIDDEN="âŒ FAIL"
          else
            echo "âœ… PASS: /docs/ja/forbidden/ was correctly blocked"
          fi

          # Python version results
          PY_RESULT_NG="âœ… PASS"
          PY_RESULT_FORBIDDEN="âœ… PASS"

          echo ""
          echo "--- Python version (site2skill) ---"
          if grep -r "robots.txt BLOCKED" .claude/skills/robots-test-python/ 2>/dev/null; then
            echo "âŒ FAIL: /docs/ng/ content was crawled despite robots.txt disallow!"
            PY_RESULT_NG="âŒ FAIL"
          else
            echo "âœ… PASS: /docs/ng/ was correctly blocked"
          fi

          if grep -r "ç¦æ­¢ã‚³ãƒ³ãƒ†ãƒ³ãƒ„" .claude/skills/robots-test-python/ 2>/dev/null; then
            echo "âŒ FAIL: /docs/ja/forbidden/ content was crawled despite robots.txt disallow!"
            PY_RESULT_FORBIDDEN="âŒ FAIL"
          else
            echo "âœ… PASS: /docs/ja/forbidden/ was correctly blocked"
          fi

          echo ""
          echo "=== robots.txt compliance verified ==="

          # Job Summary output
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ¤– robots.txt Compliance Test

          | Test | Go (site2skill-go) | Python (site2skill) |
          |------|:------------------:|:-------------------:|
          | \`/docs/ng/\` blocked | $GO_RESULT_NG | $PY_RESULT_NG |
          | \`/docs/ja/forbidden/\` blocked | $GO_RESULT_FORBIDDEN | $PY_RESULT_FORBIDDEN |
          EOF

          # Exit with error if Go tests failed (Python is for reference only)
          if [[ "$GO_RESULT_NG" == "âŒ FAIL" ]] || [[ "$GO_RESULT_FORBIDDEN" == "âŒ FAIL" ]]; then
            exit 1
          fi
