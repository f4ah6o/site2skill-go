name: site2skill hub (issue -> crawl -> release)

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  actions: read

concurrency:
  group: site2skill-hub
  cancel-in-progress: false

jobs:
  crawl:
    if: ${{ github.event.issue.user.login == github.repository_owner }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # 1. Parse & Validate (Issue Form format)
      # ----------------------------------------------------------------
      - name: Parse and Validate
        id: parse
        shell: bash
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set -euo pipefail
          # 改行コード削除（環境変数経由で安全に受け取る）
          body=$(printf '%s' "$ISSUE_BODY" | tr -d '\r')

          # "### header" の次の非空行を取得する関数
          get_field() {
            local header="$1"
            printf '%s' "$body" | awk -v h="### $header" '
              $0 ~ h { flag=1; next }
              flag && /^###/ { exit }
              flag && /^[[:space:]]*$/ { next }
              flag && NF { gsub(/^[[:space:]]+|[[:space:]]+$/, ""); print; exit }
            '
          }

          URL="$(get_field 'url')"
          NAME="$(get_field 'name')"

          echo "url=$URL"   >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"

          # Validation
          IS_VALID="true"
          if [[ -z "$URL" || -z "$NAME" ]]; then IS_VALID="false"; fi
          if [[ ! "$URL" =~ ^https:// ]]; then IS_VALID="false"; fi
          # IPアドレス除外などは簡易的に
          if echo "$URL" | grep -Eqi 'https://(localhost|127\.|0\.0\.0\.0|10\.|192\.168\.|172\.)'; then IS_VALID="false"; fi
          if echo "$NAME" | grep -Eq '[^a-zA-Z0-9._-]'; then IS_VALID="false"; fi

          echo "is_valid=$IS_VALID" >> "$GITHUB_OUTPUT"


      - name: Comment if invalid
        if: ${{ steps.parse.outputs.is_valid == 'false' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "入力が不正です。Issue Formを使用してください。\nURLはhttpsのみ、nameは英数記号(._-)のみです。"

      # ----------------------------------------------------------------
      # 2. Check Interval (Skip if blocked)
      # ----------------------------------------------------------------
      - name: Check Interval Rules
        id: interval
        if: ${{ steps.parse.outputs.is_valid == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          URL='${{ steps.parse.outputs.url }}'
          
          mkdir -p hub
          if gh release view skills >/dev/null 2>&1; then
            gh release download skills -p index.json -D hub || echo '{}' > hub/index.json
          else
            echo '{}' > hub/index.json
          fi

          # ★修正: 引数 "$URL" を <<'PY' の前に移動しました
          RESULT=$(python3 - "$URL" <<'PY'
import json, sys, time
from urllib.parse import urlparse

idx_path="hub/index.json"
url=sys.argv[1]
now=int(time.time())

try:
  data=json.load(open(idx_path,"r",encoding="utf-8"))
except:
  data={}

domain = urlparse(url).netloc.lower()
d_last = data.get("domain_last",{}).get(domain, 0)
u_last = data.get("url_last",{}).get(url, 0)

# Rules: domain 24h (86400s), url 7d (604800s)
if (now - d_last) < 86400:
    print("BLOCKED")
elif (now - u_last) < 604800:
    print("BLOCKED")
else:
    print("OK")
PY
)
          if [ "$RESULT" = "BLOCKED" ]; then
            echo "blocked=true" >> "$GITHUB_OUTPUT"
          else
            echo "blocked=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment if blocked
        if: ${{ steps.parse.outputs.is_valid == 'true' && steps.interval.outputs.blocked == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "クロール間隔ルールによりスキップしました。(Domain: 24h / URL: 7d)"

      # ----------------------------------------------------------------
      # 3. Execution
      # ----------------------------------------------------------------
      - name: Setup Go
        if: ${{ steps.parse.outputs.is_valid == 'true' && steps.interval.outputs.blocked == 'false' }}
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install site2skillgo
        if: ${{ steps.parse.outputs.is_valid == 'true' && steps.interval.outputs.blocked == 'false' }}
        run: go install github.com/f4ah6o/site2skill-go/cmd/site2skillgo@latest

      - name: Generate skill
        id: gen
        if: ${{ steps.parse.outputs.is_valid == 'true' && steps.interval.outputs.blocked == 'false' }}
        shell: bash
        run: |
          set -euo pipefail
          URL='${{ steps.parse.outputs.url }}'
          NAME='${{ steps.parse.outputs.name }}'
          
          TOOLVER="$(site2skillgo version 2>/dev/null || echo 'unknown')"
          KEY="${URL}|${NAME}|${TOOLVER}"
          HASH="$(printf "%s" "$KEY" | sha256sum | awk '{print $1}')"
          
          mkdir -p dist
          site2skillgo generate "$URL" "$NAME" --format both --output dist
          
          ZIP="$(ls -1 dist/*.zip | head -n 1)"
          OUT="dist/${NAME}--${HASH}.zip"
          mv "$ZIP" "$OUT"
          
          echo "zip=$OUT" >> "$GITHUB_OUTPUT"
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"
          echo "toolver=$TOOLVER" >> "$GITHUB_OUTPUT"

      - name: Update Index & Release
        if: ${{ steps.parse.outputs.is_valid == 'true' && steps.interval.outputs.blocked == 'false' }}
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          URL='${{ steps.parse.outputs.url }}'
          NAME='${{ steps.parse.outputs.name }}'
          HASH='${{ steps.gen.outputs.hash }}'
          TOOLVER='${{ steps.gen.outputs.toolver }}'
          ZIP_FILE='${{ steps.gen.outputs.zip }}'
          ZIP_BASE="$(basename "$ZIP_FILE")"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          NOW="$(date +%s)"

          # Pythonスクリプト: 引数を渡す正しい形式に修正
          python3 - "$URL" "$NAME" "$HASH" "$TOOLVER" "$RUN_URL" "$ZIP_BASE" "$NOW" <<'PY'
import json, sys
from urllib.parse import urlparse

idx_path="hub/index.json"
args = sys.argv
url, name, hashv, toolver, run_url, zip_base = args[1], args[2], args[3], args[4], args[5], args[6]
now = int(args[7])
domain = urlparse(url).netloc.lower()

try:
    with open(idx_path, "r", encoding="utf-8") as f:
        data = json.load(f)
except:
    data = {}

data.setdefault("items", [])
data.setdefault("domain_last", {})
data.setdefault("url_last", {})

items = [it for it in data["items"] if it.get("hash") != hashv]
items.append({
    "hash": hashv, "name": name, "url": url, "domain": domain,
    "zip": zip_base, "generated_at": now, "tool_version": toolver, "run_url": run_url
})
data["items"] = sorted(items, key=lambda x: x.get("generated_at", 0), reverse=True)

data["domain_last"][domain] = now
data["url_last"][url] = now

with open(idx_path, "w", encoding="utf-8") as f:
    json.dump(data, f, ensure_ascii=False, indent=2)
PY

          if ! gh release view skills >/dev/null 2>&1; then
            gh release create skills --title "Skills registry" --notes "Generated skills."
          fi
          gh release upload skills "$ZIP_FILE" hub/index.json --clobber
          
          REL="${{ github.server_url }}/${{ github.repository }}/releases/tag/skills"
          gh issue comment ${{ github.event.issue.number }} \
            --body "生成完了: ${NAME} (Hash: \`${HASH}\`)<br>Download: [Release Assets](${REL})<br>Source: ${URL}"

      - name: Create failure issue
        if: ${{ failure() }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          URL='${{ steps.parse.outputs.url }}'
          NAME='${{ steps.parse.outputs.name }}'
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          gh issue create --title "Crawl failed: ${NAME}" \
            --body "失敗しました。\nTarget: ${URL}\nRun: ${RUN_URL}" \
            --label "crawl-failed"
